<html>
<head>
    <meta charset="utf-8"/>
    <title>SpliceAI Lookup</title>
    <link rel="shortcut icon" href="/icon.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172722632-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-172722632-1');
    </script>

    <style>
        body, .ui.form, label {
            font-size: 11pt !important;
        }
        td {
            padding: 5px 15px;
        }
        .upperBorder {
            border-top: 1px solid black;
        }
        table {
            border-collapse: collapse;
        }
    </style>
</head>
<body>
    <div class="ui stackable grid">
        <div class="row">
        <div class="one wide column"></div>
        <div class="six wide column">
            <div style="padding:15px 0px">
                <div style="padding:10px 0px 5px 0px">
                    <b>Splice AI Score Lookup</b>
                </div>
                Enter variant(s) below to see their <a href="https://www.cell.com/cell/pdf/S0092-8674(18)31629-5.pdf" target="_blank">SpliceAI</a> scores. <br />
                This can be any SNP or InDel within the exon or intron of a gene as defined by GENCODE v24 canonical transcripts.
            </div>
            <div class="ui form" style="width:100%">

                <div class="field no-margin" style="padding-bottom: 10px;">
                    <textarea id="search-box" rows="7" style="width: 100%" placeholder="chr8-140300616-T-G or &#13;chr8:140300616 T&gt;G or &#13;chr8 &nbsp; 140300616 &nbsp; T &nbsp; G&#13;&#13;The 'chr' prefix is optional.&#13;VCF format is also supported. Lines that start with # will be skipped."></textarea>
                </div>
                <div class="ui stackable grid">
                    <div class="row">
                        <div class="thirteen wide column">
                            <div class="field" style="padding-right:10px">
                                <span style="display: inline-block; white-space: nowrap; padding-bottom:10px;"><b>Genome version:</b></span>
                                <div class="ui radio checkbox no-margin" style="padding-left:15px; padding-bottom:10px">
                                    <input type="radio" name="hg" value="37" /><label>hg19</label>
                                </div>
                                <div class="ui radio checkbox no-margin" style="padding-left:15px; padding-bottom:10px">
                                    <input type="radio" name="hg" value="38" checked /><label>hg38</label>
                                </div>
                            </div>
                            <div class="field" style="padding-right:10px; padding-bottom:12px">
                                <span style="display: inline-block; white-space: nowrap; padding-bottom:10px;"><b>Max distance:</b></span>
                                <div class="ui input" style="padding-left:15px; padding-bottom:10px; padding-right:8px; width:80px">
                                    <input id="max-distance-input" type="text" value="50" style="padding:7px 10px">
                                </div>
                                <i class="question circle outline icon" data-content="For each variant, SpliceAI looks within a window (+/- 50bp by default) to see how the variant affects the probabilities of different positions being splice acceptors or donors. The distance specified here controls the size of this window."></i>
                            </div>
                        </div>
                        <div class="three wide column">
                            <button id="submit-button" class="ui primary button">Submit</button>
                        </div>
                    </div>
            </div>
            </div>
        </div>
        <div class="eight wide column"></div>
    </div>
        <div class="row">
        <div class="one wide column"></div>
        <div class="fifteen wide column">
            <div>
                <div id="error-box" style="color:darkred"></div>
                <div id="response-box"></div>
            </div>
        </div>
    </div>
    </div>

    <script>

    function getScoreStyle(score) {
      var red = "#fccfb8"
      var yellow = "#fff19d"
      var green = "#cdffd7"

      var score = parseFloat(score)
      if (0.5 <= score && score < 0.8) {
        return "style='background-color:"+yellow+"'"
      } else if(score >= 0.8) {
        return "style='background-color:"+red+"'"
      } else {
        return "style='background-color:"+green+"'"
      }
    }

    function generateResultsTable(response) {
      return "<table>" +
        "<tr>" +
        "<td><b>variant</b></td>" +
        "<td><b>gene</b></td>" +
        "<td><b>score type</b></td>" +
        "<td><b>score</b></td>" +
        "<td><b>distance</b>  "+"<i class='question circle outline icon' data-content='For each variant, SpliceAI looks within a window (+/- 50bp by default) to see how the variant affects the probabilities of different positions being splice acceptors or donors. The distances in this column represent positions with the biggest change in probability within the window. Negative values are upstream of the variant, and positive are downstream.'></i>"+"</td>" +
        "</tr>" + response.map(function(v) {
          if (v.error) {
            return "<tr class='upperBorder'>" +
              "<td><a href='"+v.url+"' target='_blank'>"+v.variant+"</a></td>"+
              "<td colspan=4>ERROR: "+v.error+"</td>" +
              "</tr>"
          } else {
            return v.scores.map(function(scores) {
              return "<tr class='upperBorder'>" +
                "<td><a href='"+v.url+"' target='_blank'>"+v.variant+"</a></td>"+
                "<td><a href='https://www.genecards.org/cgi-bin/carddisp.pl?gene="+scores.SYMBOL+"' target='_blank'>"+scores.SYMBOL+"</a></td>" +
                "<td>Acceptor Loss</td><td "+getScoreStyle(scores.DS_AL)+">"+scores.DS_AL+"</><td>" + (parseFloat(scores.DS_AL) == 0 ? "" : "<a href='"+v.url+"' target='_blank'>"+scores.DP_AL+" bp</a>") + "</td>"+
                "</tr><tr><td></td><td></td>"+
                "<td>Donor Loss</td><td "+getScoreStyle(scores.DS_DL)+">"+scores.DS_DL+"</td><td>" + (parseFloat(scores.DS_DL) == 0 ? "" : "<a href='"+v.url+"' target='_blank'>"+scores.DP_DL+" bp</a>") + "</td>"+
                "</tr><tr><td></td><td></td>"+
                "<td>Acceptor Gain</td><td "+getScoreStyle(scores.DS_AG)+">"+scores.DS_AG+"</td><td>" + (parseFloat(scores.DS_AG) == 0 ? "" : "<a href='"+v.url+"' target='_blank'>"+scores.DP_AG+" bp</a>") + "</td>"+
                "</tr><tr><td></td><td></td>"+
                "<td>Donor Gain</td><td "+getScoreStyle(scores.DS_DG)+">"+scores.DS_DG+"</td<td>" + (parseFloat(scores.DS_DG) == 0 ? "" : "<a href='"+v.url+"' target='_blank'>"+scores.DP_DG+" bp</a>") + "</td>"+
                "</tr>"

            }).join("")
          }
        }).join("") +
        "</table>"
    }

    function parseVariants(variantsText) {
        return variantsText.split(/[\n]/)
            .filter(function(v) { return !v.startsWith("#") })
            .map(function(v) { return v.trim() })
            .filter(function(v) { return v.length > 0 })
            .map(function(v) { var fields = v.split(/[\t ]+/); if (fields.length > 4) { return fields[0] + "-" + fields[1] + "-" + fields[3] + "-" + fields[4] } else { return v } })  // reprocess VCF format to variant
            .map(function(v) { return v.replace(/([0-9]),([0-9])/g, "$1$2") })  // remove commas from numbers
            .join(",")
    }

    $(document).ready(function() {
      $('.ui.radio.checkbox').checkbox()
      $('.question').popup()

      $("#submit-button").click(function() {
        var variants = $("#search-box").val().trim()
        if (!variants) {
          return
        }
        variants = parseVariants(variants)

        var requestData = {
          hg: $("input[name='hg']:checked").val(),
          distance: $("#max-distance-input").val(),
          variants: variants,
        }

        console.log("Request:", requestData)
        $("#error-box").hide()
        $("#response-box").hide()

        $("#submit-button").addClass(["loading", "disabled"])
        $.getJSON(
          "http://34.71.77.14/spliceai/",
          requestData
        ).done(function(response) {
          console.log('API response:', response)
          $("#error-box").hide()
          $("#response-box").html(generateResultsTable(response))
          $("#response-box").show()
        }).fail(function(error) {
          $("#response-box").hide()
          $("#error-box").html(error.responseText)
          $("#error-box").show()
        }).always(function() {
          $("#submit-button").removeClass(["loading", "disabled"]);
          $('.question').popup()
        })
      })
    })
    </script>
    <!-- example variant: chr8-140300616-T-G -->
</body>
</html>
